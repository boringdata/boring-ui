import { isLoopbackHost, rewriteLoopbackForRemoteClient } from './loopbackRewrite'

const normalizeBase = (value) => (value ? value.replace(/\/$/, '') : '')

const toSearchParams = (query) => {
  if (!query) return ''
  if (query instanceof URLSearchParams) {
    const value = query.toString()
    return value ? `?${value}` : ''
  }

  const params = new URLSearchParams()
  Object.entries(query).forEach(([key, value]) => {
    if (value === undefined || value === null) return
    if (Array.isArray(value)) {
      value.forEach((entry) => {
        if (entry !== undefined && entry !== null) params.append(key, String(entry))
      })
      return
    }
    params.set(key, String(value))
  })

  const value = params.toString()
  return value ? `?${value}` : ''
}

const isDevPort = (port) => {
  const devPorts = new Set(['3000', '3001', '4173', '4174', '5173', '5174', '5175', '5176', '5180', '5190'])
  return devPorts.has(port)
}

const resolveApiBase = () => {
  const envUrl = import.meta.env.VITE_API_URL || ''
  if (envUrl) return normalizeBase(rewriteLoopbackForRemoteClient(normalizeBase(envUrl)))

  if (typeof window !== 'undefined' && window.location) {
    const { protocol, hostname, port, origin } = window.location
    if (port && isDevPort(port)) {
      return `${protocol}//${hostname}:8000`
    }
    if (origin) return origin
  }

  return 'http://localhost:8000'
}

export const getApiBase = () => resolveApiBase()

export const buildApiUrl = (path, query) => `${getApiBase()}${path}${toSearchParams(query)}`

export const getWsBase = () => {
  const apiBase = getApiBase()
  const url = new URL(apiBase)
  const protocol = url.protocol === 'https:' ? 'wss' : 'ws'
  return `${protocol}://${url.host}`
}

export const buildWsUrl = (path, query) => `${getWsBase()}${path}${toSearchParams(query)}`

export const __apiBaseTestUtils = {
  isDevPort,
  isLoopbackHost,
  rewriteLoopbackForRemoteClient,
  toSearchParams,
}
